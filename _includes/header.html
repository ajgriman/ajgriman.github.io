{%- comment -%}
Assign locale data to a shorthand variable for easier access.
This assumes your locale files are in _data/locales/ and named e.g., en.yml, es.yml
And that site.active_lang is set by jekyll-polyglot (e.g., "en", "es")
{%- endcomment -%}
{%- assign t = site.data.locales[site.active_lang] -%}

<nav class="navbar navbar-expand-lg navbar-dark bg-dark sticky-top">
    <div class="container-fluid">
        <a class="navbar-brand fw-bold" href="{{ '/' | relative_url }}">{{ t.site_title | default: site.title }}</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown"
            aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNavDropdown">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <!-- <li class="nav-item">
                    <a class="nav-link active" aria-current="page" href="{{ '/' | relative_url }}">{{ t.navbar_home |
                        default: "Home" }}</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">{{ t.navbar_projects | default: "Projects" }}</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="#">{{ t.navbar_about | default: "About" }}</a>
                </li> -->
                <!-- Example Dropdown
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
            {{ t.navbar_more | default: "More" }}
          </a>
          <ul class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
            <li><a class="dropdown-item" href="#">{{ t.navbar_action | default: "Action" }}</a></li>
            <li><a class="dropdown-item" href="#">{{ t.navbar_another_action | default: "Another action" }}</a></li>
          </ul>
        </li>
        -->
            </ul>
            <!-- Language Switcher (Revised based on Polyglot Docs for page_id) -->
            <ul class="navbar-nav fw-light fs-6">
                {% for lang_code in site.languages %}
                {% if lang_code == site.active_lang %}
                <li class="nav-item">
                    <span class="nav-link active"><strong>{{ site.data.locales[lang_code].lang_name | default: lang_code
                            | upcase }}</strong></span>
                </li>
                {% else %}
                <li class="nav-item">
                    {%- assign target_url = nil -%}

                    {%- comment %} Attempt 1: Use page.permalink_lang (new in Polyglot 1.8+, requires page_id) {%
                    endcomment %}
                    {%- if page.page_id and page.permalink_lang and page.permalink_lang[lang_code] -%}
                    {%- assign path_segment = page.permalink_lang[lang_code] -%}
                    {%- if lang_code == site.default_lang -%}
                    {%- assign target_url = path_segment | relative_url -%}
                    {%- else -%}
                    {%- assign target_url = lang_code | prepend: '/' | append: path_segment | replace_first: '//', '/' |
                    relative_url -%}
                    {%- endif -%}
                    {%- endif -%}

                    {%- comment %} Attempt 2: Fallback to site.translations if permalink_lang didn't yield a URL (older
                    method) {% endcomment %}
                    {%- unless target_url -%}
                    {%- if site.translations and page.page_id and site.translations[page.page_id] and
                    site.translations[page.page_id][lang_code] -%}
                    {%- assign translated_page_obj = site.translations[page.page_id][lang_code] -%}
                    {%- if translated_page_obj.url -%}
                    {%- assign target_url = translated_page_obj.url | relative_url -%}
                    {%- endif -%}
                    {%- endif -%}
                    {%- endunless -%}

                    {%- comment %} Attempt 3: Absolute fallback to the homepage of the target language if no specific
                    page translation found {% endcomment %}
                    {%- unless target_url -%}
                    {%- assign home_page_id_for_fallback = "home_page" -%}
                    {%- if site.translations and site.translations[home_page_id_for_fallback] and
                    site.translations[home_page_id_for_fallback][lang_code] -%}
                    {%- assign fallback_home_obj = site.translations[home_page_id_for_fallback][lang_code] -%}
                    {%- if fallback_home_obj.url -%}
                    {%- assign target_url = fallback_home_obj.url | relative_url -%}
                    {%- endif -%}
                    {%- elsif lang_code == site.default_lang -%}
                    {%- assign target_url = "/" | relative_url -%}
                    {%- else -%}
                    {%- assign target_url = lang_code | prepend: '/' | append: '/' | replace_first: '//', '/' |
                    relative_url -%}
                    {%- endif -%}
                    {%- endunless -%}

                    {%- if target_url -%}
                    <a class="nav-link" {% static_href %}href="{{ target_url }}" {% endstatic_href %}>
                        {{ site.data.locales[lang_code].lang_name | default: lang_code | upcase }}
                    </a>
                    {%- else -%}
                    <span class="nav-link text-muted">{{ site.data.locales[lang_code].lang_name | default: lang_code |
                        upcase }} (N/A)</span>
                    {%- endif -%}
                </li>
                {% endif %}
                {% endfor %}
            </ul>
        </div>
    </div>
</nav>